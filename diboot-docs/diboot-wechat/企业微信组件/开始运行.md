# 开始运行

## 说明

> 如果您是通过我们的[项目下载页面](https://www.diboot.com/g/index.html)下载的包含企业微信的项目，并且包含了移动端H5项目，则该H5项目中的登录授权接口，将自动配置为系统中内置的企业微信回调授权接口地址。该接口地址在wechat-cp模块的[WxCpAuthTokenController]()中，为[/token/wechat/cp/apply/{app}]()。
<font color=red>注意：</font>如果同时包含了微信公众号，则mobile应用的接口只有公众号接口，企业微信接口为注释状态，若微信公众号与企业微信都需要mobile应用，可将该应用复制一份到父项目下，并将另一个项目的公众号接口地址注释掉，将企业微信接口地址注释打开。

## 开始配置

* 开始运行项目前，一定要配置企业微信相关应用参数，配置方法见[配置文档](配置.md)

## 启动rest应用

* 启动rest应用，需要注意下载项目后对rest的端口以及context-path的修改，这两个的修改将需要修改mobile前端应用的相关配置，下文中提到。

## 启动mobile应用

* 安装mobile应用依赖项

```bash
npm install
// 或
yarn
```

* 检查mobile应用配置项，mobile基于vue-cli3.0版本进行构建，相关相关配置在mobile应用根目录下的[vue.config.js]()文件中。因为需要进行回调授权，所以需要将启动端口配置到80端口，同时检查rest应用启动的端口与context-path与这里的proxy选项是否匹配，这里需要匹配才可以在开发过程中请求到rest应用中的相关接口，完整配置如下：

```javascript
module.exports = {
  baseUrl: '/',
  outputDir: 'dist',
  assetsDir: 'static',
  devServer: {
    disableHostCheck: true,
    port: 80,
    proxy: {
      '/rest': {
        target: 'http://localhost:8080/rest',
        changeOrigin: true,
        pathRewrite: {
          '^/rest': '/',
        },
      },
    },
  },
};
```

* 启动mobile应用：
* 运行如下命令（如果是Mac系统，可能需要sudo权限才能运行到80端口，如 sudo yarn serve）：

```bash
yarn serve
// 或
npm run serve
```

## 域名配置

* 配置可信域名（如果已配置可省略），需要先在[企业微信官方管理后台](https://work.weixin.qq.com/)中的<font color=green>应用与小程序</font>下相对应的应用中的<font color=green>网页授权及JS-SDK</font>中配置<font color=green>可信域名</font>，并按其提示完成验证。

* 本地hosts记录中增加 对上面配置的需要使用的网页授权域名的hosts记录，比如配置的为[test.diboot.com]()，则需要增加的记录为：

```
127.0.0.1 test.diboot.com
```

* 各操作系统下的hosts记录更改方式如下：
    * MacOS修改hosts文件：Mac的hosts文件为[/etc/hosts]()，可通过sudo 命令调用相关编辑器更改hosts文件，比如: sudo gedit /etc/hosts 。
    * windows修改hosts文件：一般在C盘的[windows/system32/drivers/etc]()路径下，可能会没有权限修改，可参考[修改hosts的百度经验](https://jingyan.baidu.com/article/425e69e6e479a2be15fc16e1.html)。
    * linux修改本地hosts文件视自己情况而定。

* <font color=red>注意：</font>如果需要测试线上的微信应用，需要在hosts中将该条域名记录去除或注释掉。

## 获取回调地址

> 因为使用了企业微信的回调授权，所以需要先获取授权回调地址（企业微信的授权回调地址是按应用来分别获取的），获取方式如下：

* 启动rest应用后，在浏览器中访问 [/token/wechat/cp/buildOAuthUrl/{app}]() 接口，其中{app}需要替换为您在Cons下添加的相关应用代号，如MSG等
* 如果rest应用运行在8080端口且context-path为默认的/rest，则访问[http://localhost:8080/rest/token/wechat/cp/buildOAuthUrl/{}?url=http://test.diboot.com/test](http://localhost:8080/rest/token/wechat/cp/buildOAuthUrl/msg?url=http://)便可以得到回调地址链接。
* <font color=red>注意：</font>需要将上面链接中url后面的参数换为自己需要访问的目标地址，该地址为 <font color=green>http:// + 您配置的可信域名 + mobile应用中需要访问的路由</font>，比如上面所示为 <font color=green>http://test.diboot.com/test</font>，并且url参数中的目标地址中的http://或https://不可省略。

## 访问页面

> 通过上一步获取到的回调授权地址，将其复制到[微信开发者工具](https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html)中进行访问，即可成功授权。